<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Basic Page Needs -->
    <meta charset="utf-8" />
    <title>Mellow - Powershell</title>
    <meta name="description" content="Github projects Powershell page" />
    <meta name="author" content="George Paton" />

    <!-- Mobile Specific Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- FONT -->
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Raleway:400,300,600" />

    <!-- CSS -->
    <link rel="stylesheet" href="css/normalize.min.css" />
    <link rel="stylesheet" href="css/skeleton.min.css" />
    <link rel="stylesheet" href="css/custom.min.css" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/favicon.png">
</head>

<body>
    <!-- Background gradient -->
    <div class="background"></div>
    <!-- Main container -->
    <div class="container">
        <header>
            <div class="header-content">
                <h1>Powershell</h1>
                <ul style="padding-bottom: 1px;"><!-- pixel offset to stop odd rendering bug -->
                    <li><a class="link-effect" href="#outlook-signatures">Set Outlook 2013/2016 Signatures</a></li>
                    <li><a class="link-effect" href="#fix-sp-themes">Repair SharePoint apps after theme change</a></li>
                </ul>
            </div>
            <a href="#content">
                <div class="chevron-down fade-drop-in"></div>
            </a>
        </header>
        <div class="toc-marker" id="content"></div>
        <section>
            <div class="toc-marker" id="outlook-signatures"></div>
            <h4>Outlook Signatures</h4>
            <p>To use this script, you must place the template .docx file in the same location as the script (can be run from a GPO).
            Microsoft Word must be installed on the target machine, which should be the case if Outlook is installed.</p>
            <p>Template replacement format is [Title] which translates into the job title of the user in AD, eg.  SharePoint Designer</p>
            
            <!-- Code Rendering Block -->
            
<!-- HTML generated using hilite.me --><div class="code-block"><table><tr><td><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
</pre></td><td><pre><span class="comment">&lt;#</span>
<span class="comment">    </span><span class="comment-highlight">.SYNOPSIS</span><span class="comment"></span>
<span class="comment">    Script to set Outlook 2010/2013 e-mail signature using Active Directory information</span>
<span class="comment">    </span>
<span class="comment">    </span><span class="comment-highlight">.DESCRIPTION</span><span class="comment"></span>
<span class="comment">    This script will set the Outlook 2010/2013 e-mail signature on the local client using Active Directory information. </span>
<span class="comment">    The template is created with a Word document, where images can be inserted and AD values can be provided.</span>

<span class="comment">    Author: George Paton</span>
<span class="comment">    Version 2.1</span>
<span class="comment">#&gt;</span>

<span class="comment">###  Global Vars ###</span>
<span class="comment">## Company Variables</span>
<span class="variable">$COMPANY_LONG_NAME</span>  = <span class="string literal">&quot;Upstream Production Solutions&quot;</span>
<span class="variable">$COMPANY_SHORT_NAME</span> = <span class="string literal">&quot;Upstream PS&quot;</span>
<span class="variable">$COMPANY_INITIALS</span>   = <span class="string literal">&quot;UPS&quot;</span>
<span class="variable">$COMPANY_VAR_NAME</span>   = <span class="string literal">&quot;upstreamps&quot;</span>
<span class="variable">$COMPANY_EMAIL_EXT</span>  = <span class="string literal">&quot;@UpstreamPS.com&quot;</span>
<span class="variable">$COMPANY_EMAIL_ENC</span>  = <span class="string literal">&quot;_upstreamps_com&quot;</span>

<span class="comment">### Logging Variables</span>
<span class="variable">$LOG_FOLDER</span> = <span class="string literal">&quot;\\Log-Server\Log-Share\Logs\&quot;</span>
<span class="variable">$SIGNATURE_LOG_FOLDER</span> = <span class="string literal">&quot;Set-Outlook-Signature\&quot;</span>

<span class="comment">## Signature Variables</span>
<span class="comment"># Signature name as it shows in Outlook</span>
<span class="variable">$SIGNATURE_COMPOSE_NAME</span> = <span class="variable">$COMPANY_VAR_NAME</span>
<span class="variable">$SIGNATURE_REPLY_NAME</span>   = <span class="variable">$COMPANY_VAR_NAME</span> + <span class="string literal">&quot;-reply&quot;</span>

<span class="comment"># Separate signatures for compose/reply emails</span>
<span class="variable">$SIGNATURE_SEPARATE</span> = <span class="boolean literal">$true</span>

<span class="comment"># Signature template filenames</span>
<span class="variable">$SIGNATURE_COMPOSE_TEMPLATE</span> = <span class="string literal">&quot;template-compose.docx&quot;</span>
<span class="variable">$SIGNATURE_REPLY_TEMPLATE</span>   = <span class="string literal">&quot;template-reply.docx&quot;</span>

<span class="variable">$SIGNATURE_FORCE</span>         = <span class="boolean literal">$false</span>  <span class="comment">#Set to $true if you don&#39;t want the users to be able to change signature in Outlook</span>
<span class="variable">$SIGNATURE_FORCE_THEME</span>   = <span class="boolean literal">$true</span>   <span class="comment">#Set to $true to force Outlook default message theme within registry - ONLY IN Office 2013</span>
<span class="variable">$SIGNATURE_MARK_COMMENTS</span> = <span class="boolean literal">$true</span>   <span class="comment">#Enable marking comments in emails with initials eg. [GP] - ONLY IN Office 2013</span>

<span class="comment"># Default email compose and reply styling</span>
<span class="comment"># Colour is in BGR format, not RGB</span>
<span class="variable">$SIGNATURE_COMPOSE_FONT</span>  = <span class="string literal">&quot;Calibri&quot;</span>
<span class="variable">$SIGNATURE_COMPOSE_SIZE</span>  = 11
<span class="variable">$SIGNATURE_COMPOSE_COLOR</span> = 0x5c3405

<span class="variable">$SIGNATURE_REPLY_FONT</span>    = <span class="variable">$SIGNATURE_COMPOSE_FONT</span>
<span class="variable">$SIGNATURE_REPLY_SIZE</span>    = <span class="variable">$SIGNATURE_COMPOSE_SIZE</span>
<span class="variable">$SIGNATURE_REPLY_COLOR</span>   = <span class="variable">$SIGNATURE_COMPOSE_COLOR</span>

<span class="comment"># Maximum amount of days to elapse before autorenewing signature</span>
<span class="variable">$SIGNATURE_MAX_AGE</span>       = 60

<span class="comment"># Specify which lines to remove from completed template to handle blank fields in AD</span>
<span class="comment"># This is an ARRAY LITERAL, please read:</span>
<span class="comment"># * http://blogs.msdn.com/b/powershell/archive/2007/01/23/array-literals-in-powershell.aspx</span>
<span class="comment"># ORDER MATTERS, Items higher up will be evaluated first</span>
<span class="comment"># ^? matches any character, in this case, a newline character (so if an entire line is removed,</span>
<span class="comment"># the newline is also removed, which ensures no weird blank lines show up)</span>
<span class="variable">$SIGNATURE_TEMPLATE_BLANKS</span> =
    <span class="string literal">&quot;a: [StreetAddress], [l] [st] [postalCode]^?&quot;</span>,
    <span class="string literal">&quot;d: [TelephoneNumber] | r: [HomePhone] | m: [Mobile]^?&quot;</span>,
    <span class="string literal">&quot;d: [TelephoneNumber] | r: [HomePhone] | &quot;</span>,
    <span class="string literal">&quot;| r: [HomePhone] | m: [Mobile]&quot;</span>,
    <span class="string literal">&quot;| m: [Mobile]&quot;</span>,
    <span class="string literal">&quot;d: [TelephoneNumber] | &quot;</span>,
    <span class="string literal">&quot;r: [HomePhone] | &quot;</span>,
    <span class="string literal">&quot;[l] &quot;</span>,
    <span class="string literal">&quot;[st] &quot;</span>,
    <span class="string literal">&quot;[postalCode]&quot;</span>
<span class="comment">### /Global Vars ###</span>

<span class="keyword">if</span> (<span class="option">-not</span> <span class="variable">$SIGNATURE_SEPARATE</span>) {
    <span class="variable">$SIGNATURE_REPLY_NAME</span> = <span class="variable">$SIGNATURE_COMPOSE_NAME</span>
}

<span class="comment"># Stop execution on unhandled errors</span>
<span class="variable">$ErrorActionPreference</span> = <span class="string literal">&quot;Stop&quot;</span>

<span class="comment"># Environment variables</span>
<span class="variable">$appData</span> = (<span class="function">Get-Item</span> env<span class="colon">:</span>appdata).value
<span class="variable">$signaturePath</span> = <span class="string literal">&quot;\Microsoft\Signatures&quot;</span>
<span class="variable">$localSignaturePath</span> = <span class="variable">$appData</span> + <span class="variable">$signaturePath</span>

<span class="comment"># Check signature path, and create if necessary</span>
<span class="keyword">if</span> (<span class="option">-not</span>(<span class="function">Test-Path</span> -Path <span class="variable">$localSignaturePath</span>)) {
    <span class="function">New-Item</span> <span class="variable">$localSignaturePath</span> -Type Directory
}

<span class="comment"># Logging</span>
<span class="variable">$logPath</span> = <span class="variable">$localSignaturePath</span> + <span class="string literal">&quot;\set_outlook_signature.log&quot;</span>
<span class="keyword">if</span> (<span class="option">-not</span> (<span class="function">Test-Path</span> <span class="variable">$logPath</span>) <span class="option">-or</span> (<span class="function">Get-Item</span> <span class="variable">$logPath</span>).Length <span class="option">-gt</span> 100kb) {
    <span class="function">New-Item</span> <span class="variable">$logPath</span> -type file -force
}
<span class="function">Start-Transcript</span> -path <span class="variable">$logPath</span> -Append

<span class="comment"># Get Active Directory information for current user</span>
<span class="variable">$username</span> = <span class="variable">$env:username</span>
<span class="variable">$filter</span> = <span class="string literal">&quot;(&amp;(objectCategory=User)(samAccountName=$username))&quot;</span>
<span class="variable">$searcher</span> = <span class="function">New-Object</span> System.DirectoryServices.DirectorySearcher
<span class="variable">$searcher</span>.Filter = <span class="variable">$filter</span>
<span class="variable">$ADUserPath</span> = <span class="variable">$searcher</span>.FindOne()
<span class="variable">$ADUser</span> = <span class="variable">$ADUserPath</span>.GetDirectoryEntry()

<span class="comment">### Timestamping - lets not run this more than we need to</span>
<span class="comment"># Get last run timestamp</span>
<span class="variable">$timestampPath</span> = <span class="variable">$localSignaturePath</span> + <span class="string literal">&quot;\set_outlook_signature_timestamp.txt&quot;</span>
<span class="keyword">if</span> (<span class="option">-not</span> (<span class="function">Test-Path</span> <span class="variable">$timestampPath</span>)) {
    <span class="comment"># If no timestamp is found, the script hasn&#39;t run</span>
    <span class="comment"># So lets set last run date to the very distant past</span>
    <span class="variable">$epoch</span> = <span class="function">Get-Date</span> -Year 1970
    <span class="function">New-Item</span> <span class="variable">$timestampPath</span> -type file
    <span class="function">Add-Content</span> <span class="variable">$timestampPath</span> <span class="variable">$epoch</span>.ToFileTimeUtc()
}
<span class="variable">$timestamp</span> = <span class="snapin-reference">[DateTime]</span><span class="colon">::</span>FromFileTimeUtc((<span class="function">Get-Content</span> <span class="variable">$timestampPath</span>))
<span class="variable">$currentTime</span> = (<span class="function">Get-Date</span>).ToUniversalTime()

<span class="comment"># Get time since the last run of this script</span>
<span class="variable">$timeSinceLastRun</span> = <span class="variable">$currentTime</span>.Subtract(<span class="variable">$timestamp</span>)

<span class="keyword">if</span> (<span class="variable">$timeSinceLastRun</span>.TotalDays <span class="option">-lt</span> <span class="variable">$SIGNATURE_MAX_AGE</span>) {
    <span class="comment"># Get time since last user modification</span>
    <span class="variable">$userTimestamp</span> = <span class="variable">$ADUser</span>.whenChanged[0]
    <span class="variable">$timeSinceLastUserChange</span> = <span class="variable">$userTimestamp</span>.Subtract(<span class="variable">$timestamp</span>)

    <span class="comment"># Get time since last template change</span>
    <span class="variable">$composeTimestamp</span> = (<span class="function">Get-Item</span> <span class="variable">$SIGNATURE_COMPOSE_TEMPLATE</span>).LastWriteTimeUtc
    <span class="variable">$replyTimestamp</span> = (<span class="function">Get-Item</span> <span class="variable">$SIGNATURE_REPLY_TEMPLATE</span>).LastWriteTimeUtc
    <span class="variable">$timeSinceLastComposeChange</span> = <span class="variable">$composeTimestamp</span>.Subtract(<span class="variable">$timestamp</span>)
    <span class="variable">$timeSinceLastReplyChange</span> = <span class="variable">$replyTimestamp</span>.Subtract(<span class="variable">$timestamp</span>)

    <span class="variable">$changeDetected</span> = <span class="boolean literal">$false</span>

    <span class="comment"># Positive seconds means the timestamp is older</span>
    <span class="keyword">if</span> (<span class="variable">$timeSinceLastUserChange</span>.TotalSeconds <span class="option">-gt</span> 0) {
        <span class="function">Write-Host</span> <span class="string literal">&quot;User has been modified, renewing signature&quot;</span>
        <span class="variable">$changeDetected</span> = <span class="boolean literal">$true</span>
    }

    <span class="keyword">if</span> (<span class="variable">$timeSinceLastComposeChange</span>.TotalSeconds <span class="option">-gt</span> 0) {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Compose template has been modified, renewing signature&quot;</span>
        <span class="variable">$changeDetected</span> = <span class="boolean literal">$true</span>
    }

    <span class="keyword">if</span> (<span class="variable">$timeSinceLastReplyChange</span>.TotalSeconds <span class="option">-gt</span> 0) {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Reply template has been modified, renewing signature&quot;</span>
        <span class="variable">$changeDetected</span> = <span class="boolean literal">$true</span>
    }

    <span class="keyword">if</span> (<span class="option">-not</span> <span class="variable">$changeDetected</span>) {
        <span class="function">Write-Host</span> <span class="string literal">&quot;No changes detected, exiting...&quot;</span>
        <span class="function">Stop-Transcript</span>
        <span class="function">Copy-Item</span> <span class="variable">$logPath</span> -Destination (<span class="variable">$LOG_FOLDER</span> + <span class="variable">$SIGNATURE_LOG_FOLDER</span> + <span class="string literal">&quot;signature-&quot;</span> + <span class="variable">$username</span> + <span class="string literal">&quot;.log&quot;</span>)
        exit
    }
} <span class="keyword">else</span> {
    <span class="function">Write-Host</span> <span class="string literal">&quot;Signature is old, lets renew it&quot;</span>
}


<span class="comment"># Load word.application enums</span>
<span class="snapin-reference">[System.Reflection.Assembly]</span><span class="colon">::</span>LoadWithPartialName(<span class="string literal">&quot;Microsoft.Office.Interop.Word&quot;</span>) | <span class="function">Out-Null</span>

<span class="comment"># Text manipulation settings</span>
<span class="variable">$replaceAll</span> = <span class="snapin-reference">[Enum]</span><span class="colon">::</span>Parse(<span class="snapin-reference">[Microsoft.Office.Interop.Word.WdReplace]</span>, <span class="string literal">&quot;wdReplaceAll&quot;</span>)
<span class="variable">$matchCase</span> = <span class="boolean literal">$false</span>
<span class="variable">$matchWholeWord</span> = <span class="boolean literal">$true</span>
<span class="variable">$matchWildcards</span> = <span class="boolean literal">$false</span>
<span class="variable">$matchSoundsLike</span> = <span class="boolean literal">$false</span>
<span class="variable">$matchAllWordForms</span> = <span class="boolean literal">$false</span>
<span class="variable">$forward</span> = <span class="boolean literal">$true</span>
<span class="variable">$wrap</span> = <span class="snapin-reference">[Enum]</span><span class="colon">::</span>Parse(<span class="snapin-reference">[Microsoft.Office.Interop.Word.WdFindWrap]</span>, <span class="string literal">&quot;wdFindContinue&quot;</span>)
<span class="variable">$format</span> = <span class="boolean literal">$true</span>

<span class="comment"># Create instance of Office Word</span>
<span class="keyword">try</span> {
    <span class="variable">$MSWord</span> = <span class="function">New-Object</span> -ComObject word.application
    <span class="function">Write-Host</span> <span class="string literal">&quot;Word version is: &quot;</span> <span class="variable">$MSWord</span>.BuildFull
} <span class="keyword">catch</span> {
    <span class="function">Write-Host</span> <span class="variable">$_</span>.Exception.Message
    <span class="function">Write-Host</span> <span class="string literal">&quot;Could not load Word, checking for office install&quot;</span>
    
    <span class="variable">$comObject</span> = <span class="function">Get-ChildItem</span> HKLM<span class="colon">:</span>\Software\Classes -ea 0 | <span class="function">Where-Object</span> { <span class="variable">$_</span>.PSChildName <span class="option">-eq</span> <span class="string literal">&#39;Word.Application&#39;</span> <span class="option">-and</span> (<span class="function">Get-ItemProperty</span> <span class="string literal">&quot;$(_.PSPath)\CLSID&quot;</span> -ea 0) }
    <span class="keyword">if</span> (<span class="variable">$comObject</span> <span class="option">-ne</span> <span class="variable">$null</span>) {
        <span class="keyword">if</span> (<span class="function">Test-Path</span> <span class="string literal">&quot;C:\program files\Microsoft Office 15\ClientX86&quot;</span>) {
            <span class="function">Write-Host</span> <span class="string literal">&quot;Repairing Office 32 bit&quot;</span>
            <span class="comment"># CMD Prompt style command for background office repair</span>
            &amp; <span class="string literal">&quot;C:\program files\Microsoft Office 15\ClientX86\OfficeClickToRun.exe&quot;</span> scenario=Repair DisplayLevel=False
        } <span class="keyword">elseif</span> (<span class="function">Test-Path</span> <span class="string literal">&quot;C:\program files\Microsoft Office 15\ClientX64&quot;</span>) {
            <span class="function">Write-Host</span> <span class="string literal">&quot;Repairing Office 64 bit&quot;</span>
            <span class="comment"># CMD Prompt style command for background office repair</span>
            &amp; <span class="string literal">&quot;C:\program files\Microsoft Office 15\ClientX64\OfficeClickToRun.exe&quot;</span> scenario=Repair DisplayLevel=False
        } <span class="keyword">else</span> {
            <span class="function">Write-Host</span> <span class="string literal">&quot;OfficeClickToRun not found, repair failed&quot;</span>
        }
    } <span class="keyword">else</span> {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Word COM object not found, please check office is installed&quot;</span>
    }

    <span class="comment"># Finish transcription to log file</span>
    <span class="function">Stop-Transcript</span>

    <span class="comment"># Send log file to Logs folder</span>
    <span class="function">Copy-Item</span> <span class="variable">$logPath</span> -Destination (<span class="variable">$LOG_FOLDER</span> + <span class="variable">$SIGNATURE_LOG_FOLDER</span> + <span class="string literal">&quot;signature-&quot;</span> + <span class="variable">$username</span> + <span class="string literal">&quot;.log&quot;</span>)

    exit
}

<span class="comment"># Check for pass by reference or not</span>
<span class="comment"># This is a disgusting hack, thanks Microsoft...</span>
<span class="variable">$isPassByRef</span> = <span class="boolean literal">$true</span>
<span class="keyword">try</span> {
    <span class="variable">$MSWord</span>.Repeat(<span class="snapin-reference">[ref]</span>0)
} <span class="keyword">catch</span> {
    <span class="variable">$isPassByRef</span> = <span class="boolean literal">$false</span>
}
<span class="function">Write-Host</span> <span class="string literal">&quot;Pass by ref: &quot;</span> <span class="variable">$isPassByRef</span>


<span class="keyword">function</span> ReplaceText(<span class="variable">$find</span>, <span class="variable">$replace</span>) {
    <span class="variable">$currentDocument</span>.Select()
    <span class="keyword">try</span> {
        <span class="variable">$isMatched</span> = <span class="variable">$MSWord</span>.Selection.Find.Execute(
            <span class="variable">$find</span>,
            <span class="variable">$matchCase</span>,
            <span class="variable">$matchWholeWord</span>,
            <span class="variable">$matchWildcards</span>,
            <span class="variable">$matchSoundsLike</span>,
            <span class="variable">$matchAllWordForms</span>,
            <span class="variable">$forward</span>,
            <span class="variable">$wrap</span>,
            <span class="variable">$format</span>,
            <span class="variable">$replace</span>,
            <span class="variable">$replaceAll</span>
        )
        <span class="keyword">if</span> (<span class="variable">$isMatched</span>) {
            <span class="function">Write-Host</span> <span class="variable">$find</span> <span class="variable">$replace</span>
            <span class="keyword">return</span> <span class="boolean literal">$true</span>
        }
    } <span class="keyword">catch</span> {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Replace failed for:&quot;</span> <span class="variable">$find</span>
    }
    <span class="keyword">return</span> <span class="boolean literal">$false</span>
}

<span class="keyword">function</span> FindText(<span class="variable">$find</span>) {
    <span class="variable">$currentDocument</span>.Select()
    <span class="keyword">if</span> (<span class="variable">$MSWord</span>.Selection.Find.Execute(
        <span class="variable">$find</span>,
        <span class="variable">$matchCase</span>,
        <span class="variable">$matchWholeWord</span>,
        <span class="variable">$matchWildcards</span>,
        <span class="variable">$matchSoundsLike</span>,
        <span class="variable">$matchAllWordForms</span>,
        <span class="variable">$forward</span>,
        <span class="variable">$wrap</span>,
        <span class="variable">$format</span>
    )) {
        <span class="keyword">return</span> <span class="boolean literal">$true</span>
    }
    <span class="keyword">return</span> <span class="boolean literal">$false</span>
}

<span class="keyword">function</span> RemoveText(<span class="variable">$text</span>) {
    ReplaceText <span class="variable">$text</span> <span class="string literal">&quot;&quot;</span>
}

<span class="keyword">function</span> SetSignature(<span class="variable">$aTemplateFile</span>, <span class="variable">$aTemplateName</span>) {

    <span class="function">Write-Host</span> <span class="string literal">&quot;Copying Signature file: $aTemplateFile&quot;</span>
    <span class="keyword">try</span> {
        <span class="function">Copy-Item</span> <span class="variable">$aTemplateFile</span> <span class="variable">$localSignaturePath</span> -Recurse -Force
    } <span class="keyword">catch</span> {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Couldn&#39;t load template, error: &quot;</span> <span class="variable">$_</span>.Exception.Message
        <span class="keyword">return</span> <span class="boolean literal">$false</span>
    }
    
    <span class="comment"># Insert variables from Active Directory into file</span>
    <span class="variable">$fullPath</span> = <span class="variable">$localSignaturePath</span> + <span class="string literal">&quot;\&quot;</span> + <span class="variable">$aTemplateFile</span>
    <span class="variable">$currentDocument</span> = <span class="variable">$MSWord</span>.Documents.Open(<span class="variable">$fullPath</span>, <span class="boolean literal">$false</span>, <span class="boolean literal">$false</span>, <span class="boolean literal">$false</span>) <span class="comment">#filename, show convert file, open read-only, add to recent files</span>

    <span class="function">Write-Host</span> <span class="string literal">&quot;Setting signature values for $aTemplateName&quot;</span>
    <span class="keyword">foreach</span> (<span class="variable">$property</span> <span class="keyword">in</span> <span class="variable">$ADUser</span>.psobject.properties) {
        <span class="variable">$propertyName</span> = <span class="string literal">&quot;[&quot;</span> + <span class="variable">$property</span>.name + <span class="string literal">&quot;]&quot;</span>
        <span class="keyword">if</span> (<span class="variable">$property</span>.value <span class="option">-ne</span> <span class="variable">$null</span>) {
            ReplaceText <span class="variable">$propertyName</span> <span class="variable">$property</span>.value.toString() &gt; <span class="variable">$null</span>
        }
    }

    
    <span class="comment"># Set mail hyperlink</span>
    <span class="keyword">foreach</span> (<span class="variable">$hyperlink</span> <span class="keyword">in</span> <span class="variable">$MSWord</span>.ActiveDocument.Hyperlinks) {
        <span class="keyword">if</span> (<span class="variable">$hyperlink</span>.Name <span class="option">-eq</span> <span class="string literal">&quot;mailto:[mail]&quot;</span>) {
            <span class="variable">$mailtoLink</span> = <span class="string literal">&quot;mailto:&quot;</span> + <span class="variable">$ADUser</span>.mail
            <span class="variable">$hyperlink</span>.Address = <span class="variable">$mailtoLink</span>
        }
    }

    <span class="comment"># Remove empty lines if necessary</span>
    <span class="function">Write-Host</span> <span class="string literal">&quot;Removing empty template lines&quot;</span>
    <span class="keyword">foreach</span> (<span class="variable">$line</span> <span class="keyword">in</span> <span class="variable">$SIGNATURE_TEMPLATE_BLANKS</span>) {
        RemoveText <span class="variable">$line</span> &gt; <span class="variable">$null</span>
    }

    <span class="comment"># If any blanks failed to be removed, don&#39;t save</span>
    <span class="keyword">if</span> (FindText <span class="string literal">&quot;[&quot;</span>) {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Blank template lines found, saving failed, Please check Powershell-Vars.ps1 string removal array&quot;</span>

        <span class="variable">$currentDocument</span>.Close()
        <span class="keyword">return</span> <span class="boolean literal">$false</span>
    }
    
    <span class="comment"># Save new message signature </span>
    <span class="function">Write-Host</span> <span class="string literal">&quot;Saving signature $aTemplateName&quot;</span>

    <span class="comment"># Save HTML</span>
    <span class="variable">$saveFormat</span> = <span class="snapin-reference">[Enum]</span><span class="colon">::</span>Parse(<span class="snapin-reference">[Microsoft.Office.Interop.Word.WdSaveFormat]</span>, <span class="string literal">&quot;wdFormatHTML&quot;</span>)
    <span class="variable">$path</span> = <span class="variable">$localSignaturePath</span> + <span class="string literal">&quot;\&quot;</span> + <span class="variable">$aTemplateName</span> + <span class="string literal">&quot;.htm&quot;</span>
    <span class="keyword">try</span> {
        <span class="comment">#filename, file format, lock comments, password, add to recent files</span>
        <span class="keyword">if</span> (<span class="variable">$isPassByRef</span>) {
            <span class="variable">$currentDocument</span>.SaveAs(<span class="snapin-reference">[ref]</span><span class="variable">$path</span>, <span class="snapin-reference">[ref]</span><span class="variable">$saveFormat</span>, <span class="snapin-reference">[ref]</span><span class="boolean literal">$false</span>, <span class="snapin-reference">[ref]</span><span class="string literal">&quot;&quot;</span>, <span class="snapin-reference">[ref]</span><span class="boolean literal">$false</span>)
        } <span class="keyword">else</span> {
            <span class="variable">$currentDocument</span>.SaveAs(<span class="variable">$path</span>, <span class="variable">$saveFormat</span>, <span class="boolean literal">$false</span>, <span class="string literal">&quot;&quot;</span>, <span class="boolean literal">$false</span>)
        }
    } <span class="keyword">catch</span> {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Failed to save as HTML, error: &quot;</span> <span class="variable">$_</span>.Exception.Message
        <span class="variable">$currentDocument</span>.Close()
        <span class="keyword">return</span> <span class="boolean literal">$false</span>
    }
        
    <span class="comment"># Save RTF </span>
    <span class="variable">$saveFormat</span> = <span class="snapin-reference">[Enum]</span><span class="colon">::</span>Parse(<span class="snapin-reference">[Microsoft.Office.Interop.Word.WdSaveFormat]</span>, <span class="string literal">&quot;wdFormatRTF&quot;</span>)
    <span class="variable">$path</span> = <span class="variable">$localSignaturePath</span> + <span class="string literal">&quot;\&quot;</span> + <span class="variable">$aTemplateName</span> + <span class="string literal">&quot;.rtf&quot;</span>
    <span class="keyword">try</span> {
        <span class="keyword">if</span> (<span class="variable">$isPassByRef</span>) {
            <span class="variable">$currentDocument</span>.SaveAs(<span class="snapin-reference">[ref]</span><span class="variable">$path</span>, <span class="snapin-reference">[ref]</span><span class="variable">$saveFormat</span>, <span class="snapin-reference">[ref]</span><span class="boolean literal">$false</span>, <span class="snapin-reference">[ref]</span><span class="string literal">&quot;&quot;</span>, <span class="snapin-reference">[ref]</span><span class="boolean literal">$false</span>)
        } <span class="keyword">else</span> {
            <span class="variable">$currentDocument</span>.SaveAs(<span class="variable">$path</span>, <span class="variable">$saveFormat</span>, <span class="boolean literal">$false</span>, <span class="string literal">&quot;&quot;</span>, <span class="boolean literal">$false</span>)
        }
    } <span class="keyword">catch</span> {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Failed to save as RTF, error: &quot;</span> <span class="variable">$_</span>.Exception.Message
        <span class="variable">$currentDocument</span>.Close()
        <span class="keyword">return</span> <span class="boolean literal">$false</span>
    }
    	
    <span class="comment"># Save TXT    </span>
    <span class="variable">$saveFormat</span> = <span class="snapin-reference">[Enum]</span><span class="colon">::</span>Parse(<span class="snapin-reference">[Microsoft.Office.Interop.Word.WdSaveFormat]</span>, <span class="string literal">&quot;wdFormatText&quot;</span>)
    <span class="variable">$path</span> = <span class="variable">$localSignaturePath</span> + <span class="string literal">&quot;\&quot;</span> + <span class="variable">$aTemplateName</span> + <span class="string literal">&quot;.txt&quot;</span>
    <span class="keyword">try</span> {
        <span class="keyword">if</span> (<span class="variable">$isPassByRef</span>) {
            <span class="variable">$currentDocument</span>.SaveAs(<span class="snapin-reference">[ref]</span><span class="variable">$path</span>, <span class="snapin-reference">[ref]</span><span class="variable">$saveFormat</span>, <span class="snapin-reference">[ref]</span><span class="boolean literal">$false</span>, <span class="snapin-reference">[ref]</span><span class="string literal">&quot;&quot;</span>, <span class="snapin-reference">[ref]</span><span class="boolean literal">$false</span>)
        } <span class="keyword">else</span> {
            <span class="variable">$currentDocument</span>.SaveAs(<span class="variable">$path</span>, <span class="variable">$saveFormat</span>, <span class="boolean literal">$false</span>, <span class="string literal">&quot;&quot;</span>, <span class="boolean literal">$false</span>)
        }
    } <span class="keyword">catch</span> {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Failed to save as TXT, error: &quot;</span> <span class="variable">$_</span>.Exception.Message
        <span class="variable">$currentDocument</span>.Close()
        <span class="keyword">return</span> <span class="boolean literal">$false</span>
    }

    <span class="variable">$currentDocument</span>.Close()
    <span class="keyword">return</span> <span class="boolean literal">$true</span>
}

<span class="keyword">function</span> ExitGracefully() {
    <span class="variable">$saveOptions</span> = <span class="snapin-reference">[Enum]</span><span class="colon">::</span>Parse(<span class="snapin-reference">[Microsoft.Office.Interop.Word.WdSaveOptions]</span>,  <span class="string literal">&quot;wdDoNotSaveChanges&quot;</span>)
    <span class="keyword">if</span> (<span class="variable">$isPassByRef</span>) {
        <span class="variable">$MSWord</span>.Quit(<span class="snapin-reference">[ref]</span><span class="variable">$saveOptions</span>)
    } <span class="keyword">else</span> {
        <span class="variable">$MSWord</span>.Quit(<span class="variable">$saveOptions</span>)
    }

    <span class="comment"># Finish transcription to log file</span>
    <span class="function">Stop-Transcript</span>

    <span class="comment"># Send log file to Logs folder</span>
    <span class="function">Copy-Item</span> <span class="variable">$logPath</span> -Destination (<span class="variable">$LOG_FOLDER</span> + <span class="variable">$SIGNATURE_LOG_FOLDER</span> + <span class="string literal">&quot;signature-&quot;</span> + <span class="variable">$username</span> + <span class="string literal">&quot;.log&quot;</span>)
}

<span class="function">Write-Host</span> <span class="string literal">&quot;Waiting 2 seconds for AD object&quot;</span>
<span class="function">Start-Sleep</span> 2

<span class="comment"># Run signature filler</span>
<span class="keyword">if</span> (<span class="option">-not</span> (SetSignature <span class="variable">$SIGNATURE_COMPOSE_TEMPLATE</span> <span class="variable">$SIGNATURE_COMPOSE_NAME</span>)) {
    <span class="function">Write-Host</span> <span class="string literal">&quot;Compose Template creation failed, exiting&quot;</span>
    ExitGracefully
    exit
}
<span class="keyword">if</span> (<span class="variable">$SIGNATURE_SEPARATE</span>) {
    <span class="keyword">if</span> (<span class="option">-not</span> (SetSignature <span class="variable">$SIGNATURE_REPLY_TEMPLATE</span> <span class="variable">$SIGNATURE_REPLY_NAME</span>)) {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Reply Template creation failed, exiting&quot;</span>
        ExitGracefully
        exit
    }
}

<span class="comment"># All Office versions</span>
<span class="function">Write-Host</span> <span class="string literal">&quot;Adding signature to Office&quot;</span>
<span class="variable">$emailOptions</span> = <span class="variable">$MSWord</span>.EmailOptions
<span class="variable">$emailSignature</span> = <span class="variable">$emailOptions</span>.EmailSignature
<span class="variable">$emailCompose</span> = <span class="variable">$emailOptions</span>.ComposeStyle
<span class="variable">$emailReply</span> = <span class="variable">$emailOptions</span>.ReplyStyle

<span class="keyword">try</span> {
    <span class="variable">$emailSignature</span>.NewMessageSignature = <span class="variable">$SIGNATURE_COMPOSE_NAME</span>
    <span class="variable">$emailSignature</span>.ReplyMessageSignature = <span class="variable">$SIGNATURE_REPLY_NAME</span>
} <span class="keyword">catch</span> {
    <span class="function">Write-Host</span> <span class="string literal">&quot;Setting default signature failed, exiting&quot;</span>
    <span class="function">Write-Host</span> <span class="variable">$_</span>.Exception.Message
    ExitGracefully
}


<span class="keyword">if</span> (<span class="variable">$SIGNATURE_FORCE</span>) {
    <span class="comment"># Office 2010</span>
    <span class="keyword">If</span> (<span class="function">Test-Path</span> HKCU<span class="colon">:</span>Software\Microsoft\Office\14.0) {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Forcing set signature for Outlook 2010&quot;</span>
        <span class="function">New-ItemProperty</span> HKCU<span class="colon">:</span><span class="string literal">&#39;\Software\Microsoft\Office\14.0\Common\MailSettings&#39;</span> -Name <span class="string literal">&quot;ReplySignature&quot;</span> -Value <span class="variable">$SIGNATURE_REPLY_NAME</span> -PropertyType <span class="string literal">&quot;String&quot;</span> -Force
        <span class="function">New-ItemProperty</span> HKCU<span class="colon">:</span><span class="string literal">&#39;\Software\Microsoft\Office\14.0\Common\MailSettings&#39;</span> -Name <span class="string literal">&quot;NewSignature&quot;</span> -Value <span class="variable">$SIGNATURE_COMPOSE_NAME</span> -PropertyType <span class="string literal">&quot;String&quot;</span> -Force
    } <span class="keyword">else</span> {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Office 2010 not installed, 2010 signatures skipped&quot;</span>
    }

    <span class="comment"># Office 2013</span>
    <span class="keyword">if</span> (<span class="function">Test-Path</span> HKCU<span class="colon">:</span>Software\Microsoft\Office\15.0) {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Forcing set signature for Outlook 2013&quot;</span>
        <span class="function">New-ItemProperty</span> HKCU<span class="colon">:</span><span class="string literal">&#39;\Software\Microsoft\Office\15.0\Common\MailSettings&#39;</span> -Name <span class="string literal">&quot;ReplySignature&quot;</span> -Value <span class="variable">$SIGNATURE_REPLY_NAME</span> -PropertyType <span class="string literal">&quot;String&quot;</span> -Force
        <span class="function">New-ItemProperty</span> HKCU<span class="colon">:</span><span class="string literal">&#39;\Software\Microsoft\Office\15.0\Common\MailSettings&#39;</span> -Name <span class="string literal">&quot;NewSignature&quot;</span> -Value <span class="variable">$SIGNATURE_COMPOSE_NAME</span> -PropertyType <span class="string literal">&quot;String&quot;</span> -Force
    } <span class="keyword">else</span> {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Office 2013 not installed, 2013 signatures skipped&quot;</span>
    }
} <span class="keyword">else</span> {
    <span class="comment"># Office 2010</span>
    <span class="keyword">If</span> (<span class="function">Test-RegistryValue</span> HKCU<span class="colon">:</span><span class="string literal">&#39;\Software\Microsoft\Office\14.0\Common\MailSettings&#39;</span> <span class="string literal">&quot;NewSignature&quot;</span>) {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Removing signature enforcement for Outlook 2010&quot;</span>
        <span class="function">Remove-ItemProperty</span> HKCU<span class="colon">:</span><span class="string literal">&#39;\Software\Microsoft\Office\14.0\Common\MailSettings&#39;</span> -Name <span class="string literal">&quot;ReplySignature&quot;</span> -Force
        <span class="function">Remove-ItemProperty</span> HKCU<span class="colon">:</span><span class="string literal">&#39;\Software\Microsoft\Office\14.0\Common\MailSettings&#39;</span> -Name <span class="string literal">&quot;NewSignature&quot;</span> -Force
    }
    
    <span class="comment"># Office 2013</span>
    <span class="keyword">if</span> (<span class="function">Test-RegistryValue</span> HKCU<span class="colon">:</span><span class="string literal">&#39;\Software\Microsoft\Office\15.0\Common\MailSettings&#39;</span> <span class="string literal">&quot;NewSignature&quot;</span>) {
        <span class="function">Write-Host</span> <span class="string literal">&quot;Removing signature enforcement for Outlook 2013&quot;</span>
        <span class="function">Remove-ItemProperty</span> HKCU<span class="colon">:</span><span class="string literal">&#39;\Software\Microsoft\Office\15.0\Common\MailSettings&#39;</span> -Name <span class="string literal">&quot;ReplySignature&quot;</span> -Force
        <span class="function">Remove-ItemProperty</span> HKCU<span class="colon">:</span><span class="string literal">&#39;\Software\Microsoft\Office\15.0\Common\MailSettings&#39;</span> -Name <span class="string literal">&quot;NewSignature&quot;</span> -Force
    }
}

<span class="keyword">if</span> (<span class="variable">$SIGNATURE_FORCE_THEME</span>) {
    <span class="function">Write-Host</span> <span class="string literal">&quot;Themes are enforced, setting font for compose and reply&quot;</span>
    
    <span class="variable">$emailCompose</span>.Font.Name = <span class="variable">$SIGNATURE_COMPOSE_FONT</span>
    <span class="variable">$emailCompose</span>.Font.Size = <span class="variable">$SIGNATURE_COMPOSE_SIZE</span>
    <span class="variable">$emailCompose</span>.Font.Color = <span class="variable">$SIGNATURE_COMPOSE_COLOR</span>
    
    <span class="variable">$emailReply</span>.Font.Name = <span class="variable">$SIGNATURE_REPLY_FONT</span>
    <span class="variable">$emailReply</span>.Font.Size = <span class="variable">$SIGNATURE_REPLY_SIZE</span>
    <span class="variable">$emailReply</span>.Font.Color = <span class="variable">$SIGNATURE_REPLY_COLOR</span>
    
    <span class="comment"># Ensure no custom themes are used</span>
    <span class="variable">$emailOptions</span>.ThemeName = <span class="string literal">&quot;none&quot;</span>
}

<span class="keyword">if</span> (<span class="variable">$SIGNATURE_MARK_COMMENTS</span>) {
    <span class="function">Write-Host</span> <span class="string literal">&quot;Email comments are marked, setting mark as user initials&quot;</span>
    
    <span class="variable">$emailOptions</span>.MarkCommentsWith = <span class="variable">$MSWord</span>.UserInitials
    <span class="variable">$emailOptions</span>.MarkComments = <span class="boolean literal">$true</span>
}

<span class="comment"># Timestamp the last run time</span>
<span class="variable">$newTime</span> = (<span class="function">Get-Date</span>).ToFileTimeUtc()
<span class="function">New-Item</span> <span class="variable">$timestampPath</span> -type file -force
<span class="function">Add-Content</span> <span class="variable">$timestampPath</span> <span class="variable">$newTime</span>

ExitGracefully
</pre></td></tr></table></div>
            
            <!-- /Code Rendering Block -->
        </section>
        <section>
            <div class="toc-marker" id="fix-sp-themes"></div>
            <h4>Repair SharePoint apps after theme change</h4>
            <p>On SharePoint, if you change the theme of an App on the App Catalog, or change a theme of a site that contains an Apps, all the Apps in the App Catalog will fail catastrophically.</p>
            <p>This script is a quick fixme that requires zero configuration, just upload it to the SharePoint server and run it to repair the App Catalog entirely.</p>
            
            <!-- Code Rendering Block -->
            
<!-- HTML generated using hilite.me --><div class="code-block"><table><tr><td><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></td><td><pre><span class="comment">#!/bin/powershell</span>
<span class="comment"># Written by George Paton</span>
<span class="comment">## This little number automatically fixes that annoying app breaking bug to do with themes</span>
<span class="comment">## If an app is complaining about being unable to open a file, run me on the SP server</span>


<span class="comment"># Add the sharepoint snapin to the current session</span>
<span class="function">Add-PSSnapin</span> Microsoft.Sharepoint.Powershell

<span class="comment"># Get the app prefix</span>
<span class="variable">$prefix</span> = <span class="function">Get-SPAppSiteSubscriptionName</span>
<span class="comment"># Use the app prefix to get all app urls</span>
<span class="variable">$allappurls</span> = <span class="function">Get-SPSite</span> | <span class="function">Get-SPWeb</span> -Limit All | where {<span class="variable">$_</span>.url <span class="option">-like</span> <span class="string literal">&quot;http://$prefix*&quot;</span>}

<span class="keyword">foreach</span> (<span class="variable">$app</span> <span class="keyword">in</span> <span class="variable">$allappurls</span>)
{
    <span class="comment"># Loop through all apps within the default site with the app prefix of $prefix</span>
	<span class="variable">$name</span> = <span class="variable">$app</span>.name
	<span class="variable">$app</span>.CustomMasterUrl = <span class="string literal">&quot;/$name/_catalogs/masterpage/app.master&quot;</span>
	<span class="variable">$app</span>.MasterUrl = <span class="string literal">&quot;/$name/_catalogs/masterpage/app.master&quot;</span>
	<span class="variable">$app</span>.Update()
    echo <span class="string literal">&quot;Updating masterpage for $app&quot;</span>
}
</pre></td></tr></table></div>
            
            <!-- /Code Rendering Block -->
        </section>
    </div>
    <!-- /Main Container -->
    
    <!-- SCRIPT -->
    <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="js/polyfill.min.js"></script>
    <script src="js/custom.min.js"></script>
</body>

</html>